name: ${CONTAINER_NAME}

services:
    terminal:
        build: .
        image: ${IMAGE_NAME}
        command: ["zsh"]
        stdin_open: true
        tty: true
        working_dir: "/project"
        volumes:
            - ../../:/project
            - ../.cache/.zsh_history:/root/.zsh_history
            - ../.cache/.bash_history:/root/.bash_history
            - ../.cache/.npm/_cacache:/root/.npm/_cacache
            - ../.cache/.npm/_logs:/root/.npm/_logs
            - ../.cache/.oh-my-zsh/log:/root/.oh-my-zsh/log
            - ../.cache/.composer/cache:/root/.composer/cache
            - ../.cache/.composer/auth.json:/root/.composer/auth.json
    db:
        image: mariadb:latest
        container_name: ${COMPOSE_PROJECT_NAME}_test_db
        restart: always
        environment:
            MARIADB_DATABASE: wordpress
            MARIADB_USER: wordpress
            MARIADB_PASSWORD: wordpress
            MARIADB_ROOT_PASSWORD: root
        ports:
          - "60903:3306"
        volumes:
            - ../.cache/mysql:/var/lib/mysql
            - ../.cache/logs/mysql:/var/log/mysql
            - ./db/conf.d/my.cnf:/etc/mysql/conf.d/my.cnf
        healthcheck:
            test: ["CMD", "healthcheck.sh", "--connect", "--innodb_initialized"]
            start_period: 10s
            interval: 10s
            timeout: 5s
            retries: 3
    wordpress:
        build: ./wordpress
        container_name: ${COMPOSE_PROJECT_NAME}_test_wordpress
        restart: always
        environment:
            WORDPRESS_DB_HOST: db
            WORDPRESS_DB_USER: wordpress
            WORDPRESS_DB_PASSWORD: wordpress
            WORDPRESS_DB_NAME: wordpress
            WORDPRESS_DEBUG: true
        ports:
            - "60802:80"
            - "9004:9004"  # Expose Xdebug port
        volumes:
          - ../.cache/wordpress:/var/www/html/
          - ../../:/var/www/html/wp-content/plugins/post-expirator
          - ../../tests/Support/Data/plugins/pre-tests:/var/www/html/wp-content/plugins/pre-tests
        depends_on:
            db:
                condition: service_healthy
            mailhog:
                condition: service_started
        healthcheck:
            test: ["CMD", "test", "-f", "/var/www/html/wp-config.php"]
            interval: 10s
            timeout: 10s
            retries: 3
    wpcli:
        image: wordpress:cli-php8.4
        container_name: ${COMPOSE_PROJECT_NAME}_test_wpcli
        environment:
            WORDPRESS_DB_HOST: db
            WORDPRESS_DB_USER: wordpress
            WORDPRESS_DB_PASSWORD: wordpress
            WORDPRESS_DB_NAME: wordpress
        volumes:
            - ../.cache/wordpress:/var/www/html/
            - ../../:/var/www/html/wp-content/plugins/post-expirator
            - ../../tests/Support/Data/plugins/pre-tests:/var/www/html/wp-content/plugins/pre-tests
            - ./wpcli/prepare-wp.sh:/tmp/prepare-wp.sh
            - ./wpcli/conf.d/my.cnf:/tmp/my.cnf
            - ./wpcli/options.sql:/tmp/options.sql
        depends_on:
            wordpress:
                condition: service_healthy
            db:
                condition: service_healthy
            mailhog:
                condition: service_started
        links:
            - wordpress
            - db
            - mailhog
        working_dir: /var/www/html
        command: ["/bin/sh", "-c", "sh /tmp/prepare-wp.sh"]
    mailhog:
        image: mailhog/mailhog:latest
        container_name: ${COMPOSE_PROJECT_NAME}_test_mailhog
        ports:
            - "60980:1025" # SMTP server
            - "60981:8025" # Web UI
        environment:
            - MH_STORAGE=maildir
            - MH_MAILDIR_PATH=/maildir
        volumes:
            - ../.cache/mailhog/maildir:/maildir
        restart: always
        user: root


